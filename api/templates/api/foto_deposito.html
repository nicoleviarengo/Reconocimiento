{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tomar Foto - Reconocimiento 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            min-height: 100vh;
            color: #111827;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #e5e7eb;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 0 0 16px 16px;
            margin: 0 -20px 40px -20px;
            padding: 20px 40px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 18px;
            color: #1f2937;
        }

        .brand-dot {
            width: 12px;
            height: 12px;
            background: #a363f1;
            border-radius: 50%;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(163, 99, 241, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-name {
            font-weight: 600;
            color: #374151;
        }

        .logout-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 6px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: white;
            border: 1px solid #e5e7eb;
            padding: 10px 20px;
            border-radius: 12px;
            color: #6b7280;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 24px;
        }

        .back-btn:hover {
            background: #f9fafb;
            color: #111827;
            transform: translateX(-4px);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
        }

        .photo-card {
            background: white;
            border-radius: 24px;
            padding: 48px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            max-width: 700px;
            width: 100%;
        }

        .card-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .card-title {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .card-subtitle {
            font-size: 16px;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .arrow-icon {
            color: #f59e0b;
        }

        .photo-preview-container {
            width: 100%;
            aspect-ratio: 4/3;
            border-radius: 16px;
            overflow: hidden;
            background: #f9fafb;
            border: 2px dashed #cbd5e1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 32px;
            position: relative;
        }

        .photo-preview-container video,
        .photo-preview-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            color: #94a3b8;
        }

        .photo-placeholder p {
            font-size: 16px;
            font-weight: 500;
        }

        #videoElement {
            display: none;
        }

        #capturedImage {
            display: none;
        }

        .btn-photo {
            width: 100%;
            padding: 18px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-photo:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }

        .btn-photo:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            gap: 16px;
            margin-top: 16px;
        }

        .btn-retake {
            flex: 1;
            padding: 18px 32px;
            border: 2px solid #f59e0b;
            background: white;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #f59e0b;
        }

        .btn-retake:hover {
            background: #f59e0b;
            color: white;
        }

        .btn-continue {
            flex: 1;
            padding: 18px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-continue:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-continue:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #f59e0b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: 40px 0;
            color: #9ca3af;
            font-size: 14px;
            border-top: 1px solid #e5e7eb;
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
                margin: 0 -20px 20px -20px;
            }

            .photo-card {
                padding: 32px 24px;
            }

            .card-title {
                font-size: 24px;
            }
        }

        @media (max-width: 640px) {
            .user-info .user-name {
                display: none;
            }

            .card-subtitle {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="brand">
                <div class="brand-dot"></div>
                <span>Reconocimiento 2025</span>
            </div>
            
            <div class="user-info">
                <div class="user-avatar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z" fill="#a363f1"/>
                        <path d="M12 14C7.58172 14 4 17.5817 4 22H20C20 17.5817 16.4183 14 12 14Z" fill="#a363f1"/>
                    </svg>
                </div>
                <span class="user-name">Usuario</span>
                <button class="logout-btn" onclick="logout()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M16 17L21 12L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </header>

        <button class="back-btn" onclick="goBack()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Volver
        </button>

        <main class="main-content">
            <div class="photo-card">
                <div class="card-header">
                    <h1 class="card-title">Transferencia de Stock</h1>
                    <p class="card-subtitle">
                        Depósito 1
                        <svg class="arrow-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Depósito 2
                    </p>
                </div>

                <div class="photo-preview-container">
                    <video id="videoElement" autoplay playsinline></video>
                    <img id="capturedImage" alt="Foto capturada">
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div class="photo-placeholder" id="photoPlaceholder">
                        <svg width="120" height="120" viewBox="0 0 24 24" fill="none">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke="#cbd5e1" stroke-width="1.5"/>
                            <circle cx="8.5" cy="8.5" r="1.5" fill="#cbd5e1"/>
                            <path d="M3 16L7 12L11 16L15 12L21 18V19C21 20.1046 20.1046 21 19 21H5C3.89543 21 3 20.1046 3 19V16Z" fill="#cbd5e1"/>
                        </svg>
                        <p>Captura la imagen del inventario</p>
                    </div>
                </div>

                <button class="btn-photo" id="btnCapture" onclick="iniciarCaptura()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M23 19C23 19.5304 22.7893 20.0391 22.4142 20.4142C22.0391 20.7893 21.5304 21 21 21H3C2.46957 21 1.96086 20.7893 1.58579 20.4142C1.21071 20.0391 1 19.5304 1 19V8C1 7.46957 1.21071 6.96086 1.58579 6.58579C1.96086 6.21071 2.46957 6 3 6H7L9 3H15L17 6H21C21.5304 6 22.0391 6.21071 22.4142 6.58579C22.7893 6.96086 23 7.46957 23 8V19Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="13" r="4" stroke="white" stroke-width="2"/>
                    </svg>
                    <span id="btnCaptureText">Iniciar Cámara</span>
                </button>

                <div class="button-group" id="actionButtons" style="display: none;">
                    <button class="btn-retake" onclick="retomar()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M1 4V10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M20.49 9C19.9828 7.56678 19.1209 6.28536 17.9845 5.27542C16.8482 4.26548 15.4745 3.55976 13.9917 3.22426C12.5089 2.88875 10.9652 2.93434 9.50481 3.35677C8.04437 3.77921 6.71475 4.56473 5.64 5.64L1 10M23 14L18.36 18.36C17.2853 19.4353 15.9556 20.2208 14.4952 20.6432C13.0348 21.0657 11.4911 21.1113 10.0083 20.7757C8.52547 20.4402 7.1518 19.7345 6.01547 18.7246C4.87913 17.7146 4.01717 16.4332 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Retomar
                    </button>
                    <button class="btn-continue" id="btnContinue" onclick="procesarImagen()" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Continuar
                    </button>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>© Proyecto Reconocimiento de imágenes 2025</p>
        </footer>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p style="font-weight: 600; color: #111827;">Procesando imagen...</p>
            <p style="color: #6b7280; margin-top: 8px;">Por favor espera</p>
        </div>
    </div>

    <script>
        let stream = null;
        let imagenCapturada = null;
        let camaraActiva = false;

        window.addEventListener('DOMContentLoaded', function() {
            const card = document.querySelector('.photo-card');
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                card.style.transition = 'all 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100);
        });

        async function iniciarCaptura() {
            if (!camaraActiva) {
                await activarCamara();
            } else {
                capturarFoto();
            }
        }

        async function activarCamara() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' },
                    audio: false 
                });
                
                const video = document.getElementById('videoElement');
                video.srcObject = stream;
                video.style.display = 'block';
                
                document.getElementById('photoPlaceholder').style.display = 'none';
                document.getElementById('capturedImage').style.display = 'none';
                
                const btnCapture = document.getElementById('btnCapture');
                btnCapture.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2"/>
                        <circle cx="12" cy="12" r="4" fill="white"/>
                    </svg>
                    <span>Capturar Foto</span>
                `;
                
                camaraActiva = true;
            } catch (error) {
                console.error('Error al acceder a la cámara:', error);
                alert('No se pudo acceder a la cámara. Por favor verifica los permisos.');
            }
        }

        function capturarFoto() {
            const video = document.getElementById('videoElement');
            const canvas = document.getElementById('canvas');
            const capturedImage = document.getElementById('capturedImage');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            imagenCapturada = canvas.toDataURL('image/jpeg', 0.8);
            
            capturedImage.src = imagenCapturada;
            capturedImage.style.display = 'block';
            video.style.display = 'none';
            
            detenerCamara();
            
            document.getElementById('btnCapture').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'flex';
            document.getElementById('btnContinue').disabled = false;
        }

        function detenerCamara() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            camaraActiva = false;
        }

        function retomar() {
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('btnCapture').style.display = 'flex';
            document.getElementById('btnCapture').innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M23 19C23 19.5304 22.7893 20.0391 22.4142 20.4142C22.0391 20.7893 21.5304 21 21 21H3C2.46957 21 1.96086 20.7893 1.58579 20.4142C1.21071 20.0391 1 19.5304 1 19V8C1 7.46957 1.21071 6.96086 1.58579 6.58579C1.96086 6.21071 2.46957 6 3 6H7L9 3H15L17 6H21C21.5304 6 22.0391 6.21071 22.4142 6.58579C22.7893 6.96086 23 7.46957 23 8V19Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="12" cy="13" r="4" stroke="white" stroke-width="2"/>
                </svg>
                <span>Iniciar Cámara</span>
            `;
            document.getElementById('actionButtons').style.display = 'none';
            imagenCapturada = null;
        }

        async function procesarImagen() {
            if (!imagenCapturada) {
                alert('Por favor captura una imagen primero');
                return;
            }

            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('active');

            try {
                const response = await fetch('/api/deposito/procesar-imagen/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imagen: imagenCapturada
                    })
                });

                const data = await response.json();

                loadingOverlay.classList.remove('active');

                if (data.success) {
                    window.location.href = '/api/deposito/resumen/';
                } else {
                    alert('Error al procesar la imagen: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                loadingOverlay.classList.remove('active');
                console.error('Error:', error);
                alert('Error al procesar la imagen. Por favor intenta de nuevo.');
            }
        }

        function goBack() {
            detenerCamara();
            window.location.href = '/api/deposito/';
        }

        function logout() {
            detenerCamara();
            if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                window.location.href = '/api/login/';
            }
        }

        window.addEventListener('beforeunload', () => {
            detenerCamara();
        });
    </script>
</body>
</html>